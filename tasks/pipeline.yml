###########################################################
#  Variables 
###########################################################

- name: Check that required variables are defined (pipeline)
  assert:
    that:
      - vars[item] is defined
    fail_msg: "Variable {{ item }} needs to be defined"
  become: false
  loop:
    - amr_django_secret_key
    - amr_pipeline_db_password 

- name: Define amr_pipeline_package_deps from internal vars if not explicitily defined
  ansible.builtin.set_fact:
    amr_pipeline_package_deps: "{{ __amr_pipeline_package_deps | list }}"
  when: 
    - amr_pipeline_packages_deps is not defined
    - amr_install_pipeline_package_deps | bool

# - For simplicity and make it easy to grasp how the variables are defined
#   we are not combining environment variables (unlike the ansible-archivematica-src
#   role)
# - For example: if amr_dashboard_environment is not defined in host_vars, we use the default value
#   in vars/ (__amr_dashboard_environment) (i.e., one or the other, not a combination)

- name: Define amr_dashboard_environment from internal vars if not explicitly defined
  ansible.builtin.set_fact:
    amr_dashboard_environment: "{{ __amr_dashboard_environment }}"
  when: amr_dashboard_environment is not defined

- name: Define amr_mcpserver_environment from internal vars if not explicitly defined
  ansible.builtin.set_fact:
    amr_mcpserver_environment: "{{ __amr_mcpserver_environment }}"
  when: amr_mcpserver_environment is not defined

- name: Define amr_mcpclient_environment from internal vars if not explicitly defined
  ansible.builtin.set_fact:
    amr_mcpclient_environment: "{{ __amr_mcpclient_environment }}"
  when: amr_mcpclient_environment is not defined


###########################################################
#  OS repository configuration and package dependencies
###########################################################

- name: Install pipeline packages dependencies (dnf)
  ansible.builtin.dnf:
    name: "{{ item.name }}"
    enablerepo: "{{ item.enablerepo | default(omit) }}"
    update_cache: "{{ item.update_cache | default(omit) }}"
  loop: "{{ amr_pipeline_package_deps }}"
  when: amr_install_pipeline_package_deps | bool


###########################################################
#   Clone source repo related tasks
###########################################################

- name: Add pipeline repo dir to git safe.directory
  ansible.builtin.import_tasks: tg-git-add-safe-dir.yml
  vars:
    __repo_full_path: "{{ [amr_src_path_base, 'archivematica'] | ansible.builtin.path_join }}"

- name: Checkout pipeline code
  ansible.builtin.git:
    repo: "{{ amr_pipeline_repo }}"
    dest: "{{ [amr_src_path_base, 'archivematica'] | ansible.builtin.path_join }}"
    version: "{{ amr_pipeline_version }}"

- name: "Ensure the source code is readable by all"
  file:
    path: "{{ [amr_src_path_base, 'archivematica'] | ansible.builtin.path_join }}"
    mode: "o+rX"
    recurse: "yes"

  
###########################################################
#   Virtualenv related tasks
###########################################################

- name: Create pipeline virtualenv
  ansible.builtin.import_tasks: tg-create-virtualenv.yml
  vars:
    __virtualenv_path: "{{ [amr_virtualenv_path_base, 'archivematica'] | ansible.builtin.path_join }}"
    __requirements_path: "{{ [amr_src_path_base, 'archivematica'] | ansible.builtin.path_join }}"

###########################################################
#   Log files related config
###########################################################

- name: "Create archivematica pipeline log directories"
  ansible.builtin.file:
    dest: "{{ item }}"
    state: "directory"
    owner: "{{ amr_os_user_name }}"
    group: "{{ amr_os_group_name }}"
    mode: "g+s"
  loop:
    - "{{ amr_dashboard_log_dir }}"
    - "{{ amr_mcpserver_log_dir }}"
    - "{{ amr_mcpclient_log_dir }}"

- name: Touch pipeline log files
  ansible.builtin.file:
    path: "{{ [ item.logdir, item.filename ] | ansible.builtin.path_join }}"
    owner: "{{ amr_os_user_name }}"
    group: "{{ amr_os_group_name }}"
    state: touch
    access_time: preserve
    modification_time: preserve
  loop:
    - logdir: "{{ amr_dashboard_log_dir }}"
      filename: "dashboard.log"
    - logdir: "{{ amr_dashboard_log_dir }}"
      filename: "dashboard.debug.log"
    - logdir: "{{ amr_mcpserver_log_dir }}"
      filename: "MCPServer.log"
    - logdir: "{{ amr_mcpserver_log_dir }}"
      filename: "MCPServer.debug.log"
    - logdir: "{{ amr_mcpclient_log_dir }}"
      filename: "MCPClient.log"
    - logdir: "{{ amr_mcpclient_log_dir }}"
      filename: "MCPClient.debug.log"

- name: Create/update pipelie logging config files (/etc/archivematica/)
  ansible.builtin.template:
    src: "etc/archivematica/{{ item }}.logging.json.j2"
    dest: "/etc/archivematica/{{ item }}.logging.json"
    backup: "yes"
    owner: root
    group: root
    mode: '0664'
  loop:
    - "dashboard"
    - "serverConfig"
    - "clientConfig"

###########################################################
#   Shared directory related config
###########################################################

# - The "Shared Directory" (/var/archivematica/sharedDirectory) seems
#   to be still hardcoded in some parts of the source code (i.e., 
#   changing its value in the configuration may break the app)
# - When needing to move it to a different volume/path (e.g., due to disk
#   space issues) use symlinks

- name: Check if shared directory exists
  ansible.builtin.stat:
    path: '/var/archivematica/sharedDirectory'
  register: shareddir_st

- ansible.builtin.set_fact:
    create_shareddir: true
  when: shareddir_st.stat.exists is defined and not shareddir_st.stat.exists

- ansible.builtin.set_fact:
    create_shareddir: false
  when: shareddir_st.stat.exists is defined and shareddir_st.stat.exists

- name: Create shared directory (if it doesn't exist and there is no symlink to it)
  ansible.builtin.file:
    dest: '/var/archivematica/sharedDirectory'
    state: directory
    owner: archivematica
    group: archivematica
  when: create_shareddir

###########################################################
# Dashboard frontend (npm) related tasks
###########################################################

- name: Install front-end dependencies
  become: true
  become_user: archivematica
  command: npm install
  args:
    chdir: "{{ [amr_src_path_base, 'archivematica/src/dashboard/frontend' ] | ansible.builtin.path_join }}"

###########################################################
# Dashboard Django management commands related tasks
###########################################################

- name: "Run Dashboard django collectstatic"
  community.general.django_manage:
    command: "collectstatic"
    app_path: "{{ amr_dashboard_app_path }}"
    pythonpath: "{{ amr_amcommon_app_path }}"
    virtualenv: "{{ [amr_virtualenv_path_base, 'archivematica'] | ansible.builtin.path_join }}"
  environment: "{{ amr_dashboard_environment }}"

- name: "Run Dashboard django collectstatic"
  community.general.django_manage:
    command: "compilemessages"
    app_path: "{{ amr_dashboard_app_path }}"
    pythonpath: "{{ amr_amcommon_app_path }}"
    virtualenv: "{{ [amr_virtualenv_path_base, 'archivematica'] | ansible.builtin.path_join }}"
  environment: "{{ amr_dashboard_environment }}"

- name: "Run Dashboard django migrate"
  community.general.django_manage:
    command: "migrate"
    app_path: "{{ amr_dashboard_app_path }}"
    pythonpath: "{{ amr_amcommon_app_path }}"
    virtualenv: "{{ [amr_virtualenv_path_base, 'archivematica'] | ansible.builtin.path_join }}"
  environment: "{{ amr_dashboard_environment }}"

###########################################################
# gunicorn / systemd related configuration
###########################################################

- name: Create/update Dashboard gunicorn configuration file (/etc/archivematica/)
  ansible.builtin.template:
    src: etc/archivematica/dashboard.gunicorn-config.py.j2
    dest: /etc/archivematica/dashboard.gunicorn-config.py
    backup: true
    owner: root
    group: root
    mode: 0644
  notify: Restart Dashboard (systemd)

- name: Create/update pipeline systemd service files (/etc/systemd)
  ansible.builtin.template:
    src: "etc/systemd/system/{{ item }}.service.j2"
    dest: /etc/systemd/system/{{ item }}.service
    backup: true
    owner: root
    group: root
    mode: 0644
  loop:
    - archivematica-dashboard
    - archivematica-mcp-client
    - archivematica-mcp-server
  notify: Restart Archivematica pipeline (systemd)

- name: Create/update pipeline service env files
  ansible.builtin.template:
    src: "etc/sysconfig/{{ item }}.j2"
    dest: "{{ [amr_envvar_file_path, item] | ansible.builtin.path_join }}"
    backup: true
    owner: root
    group: root
    mode: 0644
  loop:
    - archivematica-dashboard
    - archivematica-mcp-client
    - archivematica-mcp-server
  notify: Restart Archivematica pipeline (systemd)

- name: Enable and start pipeline services (systemd)
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: started
    enabled: true
    daemon_reload: true
  loop:
    - archivematica-mcp-server
    - archivematica-mcp-client
    - archivematica-dashboard
